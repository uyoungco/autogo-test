# task 模块文档

[根目录](../CLAUDE.md) > **task**

> 本文档由 AI 架构师于 2025-11-15 17:46:19 生成

## 变更记录 (Changelog)

### 2025-11-15 17:46:19
- 初始化模块文档

---

## 模块职责

`task` 模块包含**具体的游戏业务任务实现**，包括：

1. **数据收集发送**: 收集用户信息、等级、仓库价值并上报服务器
2. **买药**: 自动购买药水、回程卷轴等物品
3. **回城**: 从副本或野外返回主城
4. **礼包领取**: 自动领取礼包奖励
5. **异常处理**: 处理各种异常场景（弹窗、卡死等）

所有任务在 `init()` 函数中自动注册到状态机。

## 入口与启动

### 自动注册

任务在包初始化时自动注册：

```go
// task/tasks.go init()
func init() {
    state.Register("数据收集发送", 数据收集发送, 0, 30*time.Minute)
}
```

### 任务执行

任务由状态机自动调度执行，无需手动调用。

## 对外接口

### 主要任务

| 任务名称 | 功能 | 执行间隔 | 优先级 |
|---------|------|---------|--------|
| `数据收集发送` | 收集用户信息和仓库价值，上报服务器 | 30 分钟 | 0 |
| `买药` | 批量购买药水、回程卷轴、钥匙 | 12 小时 | 1（已注释） |
| `礼包领取` | 自动领取礼包奖励 | - | - |

### 辅助函数

| 函数 | 功能 | 参数 | 返回值 |
|------|------|------|--------|
| `回城()` | 从副本或野外返回阿斯加德城 | 无 | error |
| `获取用户id()` | 获取游戏昵称、用户ID、等级 | 无 | error |
| `获取仓库物品价值()` | 获取仓库哈夫币价值 | 无 | (string, error) |
| `发送数据(userID, gameName, warehouseValue, level)` | 发送数据到服务器 | 用户ID, 游戏昵称, 仓库价值, 等级 | error |

### 异常处理

异常处理任务在 `exception.go` 中定义，由异常守护自动触发。

## 关键依赖与配置

### 依赖项

- `app/core`: 核心模块（OCR、OpenCV、Color、API）
- `app/scene`: 场景识别
- `app/state`: 状态机（注册任务、等待异常处理）
- `app/util`: 工具模块（HTTP 请求）
- `github.com/Dasongzi1366/AutoGo/storages`: 数据存储
- `github.com/Dasongzi1366/AutoGo/utils`: 工具函数

### 全局变量

```go
var 账号id string       // 用户账号 ID
var 游戏昵称 string      // 游戏昵称
var 等级 int = 0        // 用户等级
```

### 配置项

- 服务器地址: `http://175.24.153.109:4000`（硬编码）
- 设备编号: 从 `storages.Get("data", "windowId")` 获取

## 数据模型

### ItemConfig

```go
type ItemConfig struct {
    X, Y   int // 检测坐标
    Amount int // 增加数量 (100, 200, 1000)
}
```

用于批量购买药水时的物品配置。

## 任务详解

### 数据收集发送

**流程**：
1. 等待异常处理完成（`state.Wait()`）
2. 判断是否已有账号 ID
   - 如果没有，执行完整流程：获取用户 ID → 点击仓库 → 获取仓库价值
   - 如果已有，直接获取仓库价值
3. 发送数据到服务器

**场景要求**：
- 获取用户 ID: 需要在"主界面"或"主界面2"
- 获取仓库价值: 需要在"界面仓库"

**数据上报接口**：
- `POST http://175.24.153.109:4000/device/update`
- 参数: `deviceCode`, `accountId`, `gameName`, `havalCoinAmount`, `level`

### 买药

**流程**：
1. 执行回城操作
2. 检查是否在阿斯加德城
3. 点击主城导航 → 点击药水商人
4. 等待杂货商人出现（OCR 识别）
5. 点击"批量购买设置"
6. 遍历配置的物品列表，为每个物品设置批量购买数量
7. 点击"设置保存" → 点击"批量购买" → 点击"购买"
8. 关闭所有弹窗

**物品配置**：
```go
itemConfigs := []ItemConfig{
    {X: 873, Y: 237, Amount: 1000}, // 中药水
    {X: 583, Y: 393, Amount: 100},  // 回程卷轴
    {X: 854, Y: 383, Amount: 100},  // 钥匙
}
```

### 回城

**流程**：
1. 检查是否在副本内（有"退出地图"按钮）
   - 如果在副本，点击"退出地图" → 点击"移动"
2. 检查是否在阿斯加德城
   - 如果在，直接返回
3. 使用回程卷轴（如果有）
4. 如果还不在阿斯加德城，打开地图强制回程

**场景识别**：
- 使用 `scene.Identify("scene_map")` 识别当前地图

### 礼包领取

**流程**：
1. 查找"礼包"图标并点击
2. 循环 5 次，查找红点（颜色 `ba0404`）
3. 点击有红点的礼包 → 点击"领取"按钮（颜色 `a60304`）
4. 点击空白处关闭
5. 关闭所有弹窗

## 测试与质量

### 当前测试覆盖

- 无自动化测试
- 通过实际运行验证功能

### 建议补充

1. 单元测试：辅助函数（如 `获取用户id`、`获取仓库物品价值`）
2. Mock 测试：模拟 OCR、OpenCV、HTTP 请求
3. 集成测试：完整任务流程

## 常见问题 (FAQ)

### 1. 数据收集发送失败怎么办？

- 检查网络连接和服务器地址
- 检查设备编号是否正确（`windowId`）
- 查看日志了解具体错误原因

### 2. 买药任务未执行？

任务已在 `init()` 中注释掉，如需启用：
```go
state.Register("买药", 买药, 1, 12*time.Hour)
```

### 3. 回城失败怎么办？

- 检查是否有回程卷轴
- 检查地图名称是否能正确识别（`scene_map.json`）
- 查看日志了解卡在哪个步骤

### 4. OCR 识别韩文失败？

- 检查 OCR 密钥是否有效
- 调整相似度阈值（建议 0.6-0.8）
- 确保检测区域正确

### 5. 如何添加新任务？

1. 在 `tasks.go` 中定义任务函数（类型为 `func() error`）
2. 在 `init()` 中注册任务：
   ```go
   state.Register("新任务", 新任务函数, 顺序, 间隔)
   ```
3. 如需场景识别，在 `assets/config/scene.json` 添加场景配置

## 相关文件清单

### 核心源码

- `tasks.go`: 主要任务实现
- `exception.go`: 异常处理任务

### 配置文件

- `../assets/config/scene.json`: 场景识别配置
- `../assets/config/scene_map.json`: 地图场景配置

### 相关模块

- `../core/`: 核心模块（OCR、OpenCV、Color、API）
- `../scene/`: 场景识别
- `../state/`: 状态机
- `../util/`: 工具模块

---

**模块统计**:
- 文件数: 2
- 任务数: 4+
- 辅助函数: 4
- 全局变量: 3
